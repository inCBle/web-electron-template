---
theme: channing-cyan
---

# Electron è¿›ç¨‹é—´é€šä¿¡ IPCï¼ˆInter-Process Communicationï¼‰

## å‰è¨€

é¦–å…ˆï¼Œå¤§å®¶éœ€è¦çŸ¥é“ Electron æ˜¯é€šè¿‡å°† chrome Chromium å†…æ ¸ å’Œ Node.js åµŒå…¥åˆ°ä¸€ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶ä¸­æ¥å®ç°æ„å»ºè·¨å¹³å°æ¡Œé¢åº”ç”¨çš„æ¡†æ¶ã€‚
è€Œå› æ­¤åŸå› ï¼Œæ‰€ä»¥ Electron åº”ç”¨åŒæ—¶å…·å¤‡æ“ä½œ DOMã€BOM å’Œ Node.js çš„èƒ½åŠ›ã€‚

## Electron ä¸­çš„è¿›ç¨‹

Electron ç»§æ‰¿äº† Chromium çš„å¤šè¿›ç¨‹æ¶æ„ï¼Œè¿™ä½¿å¾—è¯¥æ¡†æ¶åœ¨æ¶æ„ä¸Šä¸ç°ä»£ Web æµè§ˆå™¨éå¸¸ç›¸ä¼¼

### ä¸ºä»€ä¹ˆæ˜¯å¤šè¿›ç¨‹æ¶æ„ï¼Ÿ

è¿™æ˜¯å› ä¸º web æµè§ˆå™¨æ˜¯æå…¶å¤æ‚çš„åº”ç”¨ã€‚é™¤äº†æ˜¾ç¤º Web å†…å®¹çš„ä¸»è¦èƒ½åŠ›ä¹‹å¤–ï¼Œä»–ä»¬è¿˜æœ‰è®¸å¤šæ¬¡è¦èŒè´£ï¼Œä¾‹å¦‚ç®¡ç†å¤šä¸ªçª—å£ï¼ˆæˆ–é€‰é¡¹å¡ï¼‰å’ŒåŠ è½½ç¬¬ä¸‰æ–¹æ‰©å±•ã€‚
åœ¨æ—©æœŸï¼Œæµè§ˆå™¨é€šå¸¸ä½¿ç”¨å•ä¸ªè¿›ç¨‹æ¥å®ç°æ‰€æœ‰è¿™äº›åŠŸèƒ½ã€‚å°½ç®¡è¿™ç§æ¨¡å¼æ„å‘³ç€ä½ æ‰“å¼€çš„æ¯ä¸ªé€‰é¡¹å¡çš„å¼€é”€æ›´å°‘ï¼Œä½†è¿™ä¹Ÿæ„å‘³ç€ä¸€ä¸ªç½‘ç«™å´©æºƒæˆ–æŒ‚èµ·ä¼šå½±å“æ•´ä¸ªæµè§ˆå™¨ã€‚
æ€»è€Œè¨€ä¹‹ï¼Œå¤šè¿›ç¨‹æ¶æ„ä½¿å…¶åº”ç”¨æ›´åŠ ç¨³å®šåŠå®‰å…¨ï¼Œä¸ä¼šå› ä¸ºæŸä¸ªè¿›ç¨‹æŒ‚æ‰è€Œæ˜¯å…¶ä»–è¿›ç¨‹ä¸­çš„åº”ç”¨å—åˆ°å½±å“ã€‚

åœ¨ **Electron** åº”ç”¨ä¸­ä¸»è¦åˆ†ä¸º **ä¸»è¿›ç¨‹ï¼ˆmainï¼‰** è·Ÿ **æ¸²æŸ“è¿›ç¨‹ï¼ˆrendererï¼‰**ï¼Œä»–ä»¬åˆ†åˆ«ä¸ºï¼š

- ä¸»è¿›ç¨‹ï¼šä½œä¸º **Electron** åº”ç”¨çš„å…¥å£è¿›ç¨‹ï¼Œå®ƒè¿è¡Œåœ¨ Node ç¯å¢ƒä¸­ï¼Œå› æ­¤å®ƒå¯ä»¥ä½œä¸ºä¸€ä¸ªæœåŠ¡å™¨ç»™æ¸²æŸ“è¿›ç¨‹æä¾›è°ƒç”¨ç³»ç»Ÿçº§ API çš„æ”¯æŒ
- æ¸²æŸ“è¿›ç¨‹ï¼šè´Ÿè´£æ¸²æŸ“é¡µé¢ï¼Œè¿è¡Œåœ¨ chromium æµè§ˆå™¨å†…æ ¸ä¸­ï¼Œå¯ä»¥è°ƒç”¨æµè§ˆå™¨æä¾›çš„ WebAPIï¼Œå®ƒè·Ÿä¸€ä¸ª chrome æµè§ˆå™¨æ²¡æœ‰ä»»ä½•åŒºåˆ«

## ä»€ä¹ˆæ˜¯è¿›ç¨‹ï¼Ÿ

1. è¿›ç¨‹æ˜¯æ“ä½œç³»ç»Ÿèƒ½å¤Ÿç‹¬ç«‹æ‰§è¡Œçš„ä¸€ä¸ªç¨‹åºï¼Œæ¯ä¸ªè¿›ç¨‹éƒ½æœ‰è‡ªå·±çš„å†…å­˜ç©ºé—´ã€‚
2. è¿›ç¨‹æ˜¯æ“ä½œç³»ç»Ÿå†…æ ¸ä¸ºåº”ç”¨ç¨‹åºåˆ†é…çš„èµ„æºï¼ŒåŒ…æ‹¬å†…å­˜ã€CPU æ—¶é—´ã€I/O è®¾å¤‡ç­‰ã€‚
3. è¿›ç¨‹é—´æ˜¯ç›¸äº’ç‹¬ç«‹çš„ï¼Œäº’ä¸å½±å“çš„ã€‚
4. è¿›ç¨‹é—´é€šä¿¡æ˜¯è¿›ç¨‹é—´äº¤äº’çš„ä¸€ç§æ–¹å¼ã€‚

## å®‰å…¨é—®é¢˜

### nodeIntegration

### contextIsolation

### preload

ä¸ºä»€ä¹ˆä¼šæœ‰ preload ï¼Ÿå‡ºäºå®‰å…¨åŸå› ï¼Œæ¸²æŸ“å™¨è¿›ç¨‹é»˜è®¤è¿è¡Œç½‘é¡µå¹¶ä¸”ä¸è¿è¡Œ Node.jsã€‚æ‰€ä»¥ä¸ºäº†å°† Electron çš„ä¸åŒè¿›ç¨‹ç±»å‹æ¡¥æ¥åœ¨ä¸€èµ·ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨ä¸€ä¸ªç§°ä¸ºé¢„åŠ è½½çš„ç‰¹æ®Šè„šæœ¬ã€‚æ€»è€Œè¨€ä¹‹å°±æ˜¯æä¾›ä¸€ä¸ªå¯ä»¥å®‰å…¨è®¿é—®**ç³»ç»Ÿ API** çš„æ²™ç›’ç¯å¢ƒç»™æ¸²æŸ“è¿›ç¨‹ã€‚

- preload è„šæœ¬ä¸­å¯ä»¥è®¿é—® WebAPI ä»¥åŠæœ‰é™çš„ Node.js å’Œ Electron APIã€‚

> ä» Electron 20 å¼€å§‹ï¼Œé¢„åŠ è½½è„šæœ¬é»˜è®¤è¢«æ²™ç®±åŒ–ï¼Œå¹¶ä¸”ä¸å†èƒ½å¤Ÿè®¿é—®å®Œæ•´çš„ Node.js ç¯å¢ƒã€‚
>
> |    å¯ç”¨çš„ API     |                     ç»†èŠ‚                      |
> | :---------------: | :-------------------------------------------: |
> |   Electron æ¨¡å—   |                 æ¸²æŸ“è¿›ç¨‹æ¨¡å—                  |
> |    Node.js API    |              eventsã€urlã€timers              |
> | Polyfill å…¨å±€å˜é‡ | Bufferã€processã€clearImmediateã€setImmediate |

#### contextBridge

åœ¨ preload è„šæœ¬ä¸­ï¼Œä½¿ç”¨ contextBridge.exposeInMainWorld(apiKey, api) æˆ– contextBridge.exposeInIsolatedWorld(worldId,apiKey, api) æ–¹æ³•å°† api æš´éœ²ç»™æ¸²æŸ“è¿›ç¨‹ã€‚

> contextBridge.exposeInMainWorld(apiKey, api)

## ä¸»è¿›ç¨‹

## æ¸²æŸ“è¿›ç¨‹

## è¿›ç¨‹é€šä¿¡

### ipcMain

### ipcRenderer

## é€šä¿¡æ¨¡å¼

### æ¨¡å¼ä¸€ æ¸²æŸ“è¿›ç¨‹ ==> ä¸»è¿›ç¨‹ï¼ˆå•å‘ï¼‰

è¿™ç§æ¨¡å¼é€šå¸¸æ˜¯æ¸²æŸ“è¿›ç¨‹éœ€è¦è°ƒç”¨ä¸»è¿›ç¨‹çš„ api åšä¸€äº›æ“ä½œï¼Œè€Œæ— éœ€ç­‰å¾…ä¸»è¿›ç¨‹çš„æ‰§è¡Œç»“æœã€‚ä¾‹å¦‚ä¸‹é¢ä¸€ä¸ªåŠ¨æ€ä¿®æ”¹çª—å£ title çš„ç¤ºä¾‹ã€‚

1. ä½¿ç”¨ **ipcRenderer.send(channel, ...args)** æ–¹æ³•å‘é€æ¶ˆæ¯ç»™ä¸»è¿›ç¨‹ã€‚
2. åœ¨ä¸»è¿›ç¨‹ï¼ˆmain.tsï¼‰ä¸­ï¼Œä½¿ç”¨ **ipcMain.on(channel, callback)** æ–¹æ³•ç›‘å¬æ¶ˆæ¯ã€‚

```ts
// main.ts
import { ipcMain } from 'electron'

ipcMain.on("set-title", (event, title) => {
  const win = BrowserWindow.fromWebContents(event.sender);
  win?.setTitle(title);
});

// preload.ts
import { contextBridge, ipcRenderer } from 'electron'

contextBridge.exposeInMainWorld('electron', {
    setTitle: (title: string) => {
        ipcRenderer.send('set-title', title)
    }
})

// App.vue
<script setup lang="ts">
import { ref } from "vue";
const title = ref("App Title");

function setTitle() {
  window.electron.setTitle(title.value);
}
</script>

<template>
  <input type="text" v-model="title" />
  <button @click="setTitle">ç¡®è®¤</button>
</template>

```

### æ¨¡å¼äºŒ ä¸»è¿›ç¨‹ <==> æ¸²æŸ“è¿›ç¨‹

åŒå‘ IPC çš„å¸¸è§åº”ç”¨æ˜¯ä»æ¸²æŸ“å™¨è¿›ç¨‹ä»£ç ä¸­è°ƒç”¨ä¸»è¿›ç¨‹æ¨¡å—å¹¶ç­‰å¾…ç»“æœã€‚è¿™å¯ä»¥é€šè¿‡ä½¿ç”¨ **ipcRenderer.invoke** ä¸ **ipcMain.handle** é…å¯¹æ¥å®Œæˆã€‚å°†ä¸Šè¯‰ä»£ç åœ¨ç®€å•å¢åŠ ä¸€ä¸ªåˆå§‹åŒ–æ—¶é»˜è®¤è·å–å½“å‰çª—å£çš„ title çš„éœ€æ±‚ã€‚

1. ä½¿ç”¨ **ipcMain.handle** ç›‘å¬æ¸²æŸ“è¿›ç¨‹çš„ **ipcRenderer.invoke('get-title')** äº‹ä»¶
2. åœ¨ preload è„šæœ¬å°†è°ƒç”¨ **ipcRenderer.invoke('get-title')** çš„è°ƒç”¨ç»“æœè¿”å›ç»™æ¸²æŸ“è¿›ç¨‹
3. åœ¨æ¸²æŸ“è¿›ç¨‹è°ƒç”¨ **window.electron.getTitle()** è·å–çª—å£æ ‡é¢˜

```ts
// main.ts
import { ipcMain } from "electron";

ipcMain.on("set-title", (event, title) => {
  const win = BrowserWindow.fromWebContents(event.sender);
  win?.setTitle(title);
});

// +
ipcMain.handle("get-title", (event) => {
  const webContents = event.sender;
  const win = BrowserWindow.fromWebContents(webContents);
  return win?.getTitle();
});

// preload.ts
import { contextBridge, ipcRenderer } from "electron";

contextBridge.exposeInMainWorld("electron", {
  setTitle: (title: string) => {
    ipcRenderer.send("set-title", title);
  },

// +
  getTitle: () => {
    return ipcRenderer.invoke("get-title");
  },
});

// App.vue
<script setup lang="ts">
import { ref } from "vue";
const title = ref("App Title");

function setTitle() {
  window.electron.setTitle(title.value);
}

// +
window.electron.getTitle().then((value) => {
  title.value = value;
});

</script>

<template>
  <input type="text" v-model="title" />
  <button @click="setTitle">ç¡®è®¤</button>
</template>
```

ipcRenderer.invoke æ˜¯ electron 7 ä¸­æ·»åŠ çš„æ–° apiï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ ipcRenderer.send è·Ÿ ipcRenderer.sendSync æ¥å®ç°åŒå‘é€šä¿¡ï¼Œä½†å¹¶ä¸æ¨èã€‚å…¶åŸå› ä¾¿æ˜¯å¼€å‘ä»£ç çš„å†—ä½™è·ŸåŒæ­¥ä»£ç å¸¦æ¥çš„æ€§èƒ½é˜»å¡é—®é¢˜ã€‚[å‚è€ƒ](https://www.electronjs.org/zh/docs/latest/tutorial/ipc#%E6%B3%A8%E6%84%8F%E5%AF%B9%E4%BA%8E%E6%97%A7%E6%96%B9%E6%B3%95)

### æ¨¡å¼ä¸‰ ä¸»è¿›ç¨‹ ==> æ¸²æŸ“è¿›ç¨‹

å½“ä»ä¸»è¿›ç¨‹å‘æ¸²æŸ“å™¨è¿›ç¨‹å‘é€æ¶ˆæ¯æ—¶ï¼Œéœ€è¦æŒ‡å®šå“ªä¸ªæ¸²æŸ“å™¨æ­£åœ¨æ¥æ”¶è¯¥æ¶ˆæ¯ã€‚æ¶ˆæ¯éœ€è¦é€šè¿‡æ¸²æŸ“å™¨è¿›ç¨‹çš„ **WebContents** å®ä¾‹å‘é€åˆ°æ¸²æŸ“å™¨è¿›ç¨‹ã€‚æ­¤ WebContents å®ä¾‹åŒ…å«ä¸€ä¸ª **send** æ–¹æ³•ï¼Œå…¶ä½¿ç”¨æ–¹å¼ä¸ **ipcRenderer.send** ç›¸åŒã€‚ä»¥ä¸‹ç”¨ä¸€ä¸ªæé†’ç”¨æˆ·çš„æµ‹è¯•ç”¨ä¾‹å±•ç¤ºï¼š

1. ä½¿ç”¨ **Menu.buildFromTemplate** æ·»åŠ ä¸€ä¸ª "æé†’ç”¨æˆ·" çš„èœå•æŒ‰é’®ï¼Œå¹¶æ·»åŠ  **send** äº‹ä»¶
2. preload ä¸­æ·»åŠ  **onMessage** å‡½æ•°æš´éœ²ç»™æ¸²æŸ“è¿›ç¨‹ç›‘å¬ä¸»è¿›ç¨‹å‘èµ·çš„ä¿¡æ¯ã€‚
3. renderer ä¸­è°ƒç”¨ **window.electron.onMessage()**
4. è¿˜å¯ä»¥åœ¨ preload ä¸­æ·»åŠ  **sendMessage** å‡½æ•°æ¥ç»™ä¸»è¿›ç¨‹å›å¤æ¶ˆæ¯ï¼Œå½“ç„¶ï¼Œè¿™ä¸æ˜¯å¿…é¡»çš„ã€‚

```ts
// main.ts
const win = new BrowserWindow({
  width: 960,
  height: 600,
  webPreferences: {
    preload: path.join(__dirname, "./preload.js"),
    nodeIntegration: false, // è®¾ç½®æ˜¯å¦åœ¨é¡µé¢ä¸­å¯ç”¨ Node.js é›†æˆæ¨¡å¼
    contextIsolation: true, // è®¾ç½®æ˜¯å¦å¯ç”¨ä¸Šä¸‹æ–‡éš”ç¦»æ¨¡å¼ã€‚
  },
});


ipcMain.on('send-message', (_, message) => {
  console.log(message) // æ‰“å°ï¼š"æ”¶åˆ°æ¶ˆæ¯äº†ğŸ˜‰"
})

const menu = Menu.buildFromTemplate([
  {
    label: "æé†’ç”¨æˆ·",
    click: () => {
      win.webContents.send("send-message", "æµ‹è¯•æ¶ˆæ¯");
    },
  },
]);

win.setMenu(menu);

// preload.ts
import { contextBridge, ipcRenderer } from 'electron'

contextBridge.exposeInMainWorld('electron', {
    onMessage: (callback: (...args: any[]) => void) => {
        ipcRenderer.on('send-message', (_, ...args) => callback(...args))
    }
    sendMessage: (message: string) => {
        ipcRenderer.send('sand-message', message)
    }
})

// App.vue
window.electron.onMessage((value) => {
  window.alert(value);
  window.electron.sendMessage("æ”¶åˆ°æ¶ˆæ¯äº†ğŸ˜‰")
});

```

![Alt text](eIMScreenShot20250613095733954.jpg)

### æ¨¡å¼å›› æ¸²æŸ“è¿›ç¨‹ 1 <==> æ¸²æŸ“è¿›ç¨‹ 2

æ²¡æœ‰ç›´æ¥çš„æ–¹æ³•å¯ä»¥ä½¿ç”¨ ipcMain å’Œ ipcRenderer æ¨¡å—åœ¨ Electron ä¸­çš„æ¸²æŸ“è¿›ç¨‹ä¹‹é—´å‘é€æ¶ˆæ¯ã€‚æƒ³è¦å®ç°è¿™ç§æ¨¡å¼ï¼Œæœ‰ä¸¤ç§é€‰æ‹©ï¼š

- ä½¿ç”¨ä¸»è¿›ç¨‹ä½œä¸ºæ¸²æŸ“è¿›ç¨‹ä¹‹é—´çš„æ¶ˆæ¯ä»£ç†ï¼Œç”±æ¸²æŸ“è¿›ç¨‹åƒä¸»è¿›ç¨‹å‘é€æ¶ˆæ¯ï¼Œåœ¨ç”±ä¸»è¿›ç¨‹å°†æ¶ˆæ¯è½¬å‘åˆ°å¦ä¸€ä¸ªæ¸²æŸ“è¿›ç¨‹ã€‚
- ä½¿ç”¨ [MessagePort](https://electron.nodejs.cn/docs/latest/tutorial/message-ports) ä»ä¸»è¿›ç¨‹ä¼ é€’åˆ°ä¸¤ä¸ªæ¸²æŸ“å™¨ã€‚è¿™å°†å…è®¸åœ¨åˆå§‹åŒ–åæ¸²æŸ“å™¨ä¹‹é—´è¿›è¡Œç›´æ¥é€šä¿¡ã€‚

 [MessageChannel API](https://developer.mozilla.org/zh-CN/docs/Web/API/MessageChannel)
